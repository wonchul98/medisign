<html>
    <head>
        <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=qtyqr5m94a"></script>
        <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    </head>

    <body>
        <div style="margin-top: 20px; margin-bottom: 10px; font-weight: bold;">
            주변 약국
        </div>
        <div id="map" style="width:100%; height:80%">

        </div>
        
        <script>
            $(document).ready(async function(){
                let XY = await getLocation();
            
                
                //지도를 삽입할 HTML 요소 또는 HTML 요소의 id를 지정합니다.
                var mapDiv = document.getElementById('map'); // 'map'으로 선언해도 동일

                
                // 현재 user 위치에 pin 고정
                var HOME_PATH = window.HOME_PATH || '.';
                var defaultMarker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(XY.lat, XY.lng),
                    map: map,
                    title : '현재 user의 위치'
                });
                
                
                $.ajax({
                    url: "/pharmacies/nearby",
                    type: "GET",
                    cache: false,
                    dataType: "json",
                    
                    data: {"lat" : XY.lat, "lon": XY.lng, "distance_km": "1"},
                    
                    success: function(data) {
                        console.log(data);
                        var map = new naver.maps.Map('map', {
                            center: new naver.maps.LatLng(XY.lat, XY.lng), //지도의 초기 중심 좌표
                            zoom: 13, //지도의 초기 줌 레벨
                            minZoom: 7, //지도의 최소 줌 레벨
                            zoomControl: true, //줌 컨트롤의 표시 여부
                            zoomControlOptions: { //줌 컨트롤의 옵션
                                position: naver.maps.Position.TOP_RIGHT
                            }
                        });
                        data.forEach(function(it, index){
                            let care_institution_name = it.care_institution_name // 약국 명
                            let address = it.address //주소
                            let phone_number = it.phone_number// 번호

                            let pharmacy_location = new naver.maps.LatLng(it.coord_y, it.coord_x);
                            let marker = new naver.maps.Marker({
                                map: map,
                                position: pharmacy_location
                            });
                        
                            var contentString = [
                                    '<div class="iw_inner">',
                                    '   <h3>'+care_institution_name+'</h3>',
                                    '   <p>'+address+'<br />',
                                    '       '+phone_number+'<br />',
                                    '   </p>',
                                    '</div>'
                                ].join('');
                            
                            var infowindow = new naver.maps.InfoWindow({
                                content: contentString
                            });
                            
                            naver.maps.Event.addListener(marker, "click", function(e) {
                                if (infowindow.getMap()) {
                                    infowindow.close();
                                } else {
                                    infowindow.open(map, marker);
                                }
                            });
                        
                        infowindow.open(map, marker);
                        });
                        
                    },
                    error: function(request, status, error) {
    
                    }
                });
                
            });
            
            async function getLocation() {
                let XY = new Object();
                if(navigator.geolocation) {
    
                    let promise = new Promise((resolve, rejected) => {
                        navigator.geolocation.getCurrentPosition((position) => {
                            resolve(position);
                        });
                    });
    
                    let position = await promise;
                    // position.coords.latitude 위도
                    // position.coords.longitude 경도
                    XY.lat = position.coords.latitude;
                    XY.lng = position.coords.longitude;
                }
                return XY;            
            }
            
        </script>
    </body>
</html>